<!DOCTYPE html>
<html ng-app="RadioApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poesia y Cumbia Radio</title>
    
    <!-- include CAPH 3.1.0 default package -->
    <link href="lib/caph/3.1.0/caph.min.css" rel="stylesheet" type="text/stylesheet">
    
    <!-- Custom styles -->
    <link href="css/style.css" rel="stylesheet" type="text/css">

    <!-- include jQuery file (you can use AngularJS & jQuery in your environment) -->
    <script src="lib/caph/3.1.0/bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="lib/caph/3.1.0/bower_components/angular/angular.min.js" type="text/javascript"></script>

    <!-- include the CAPH Package for AngularJS -->
    <script src="lib/caph/3.1.0/caph-angular.min.js" type="text/javascript"></script>

    <!-- HLS.js library for HLS stream support (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body ng-controller="RadioController">
    <!-- Modal de carga -->
    <div class="loading-modal" ng-show="showLoadingModal">
        <img src="images/logo.png" alt="Poesía y Cumbia Radio" class="loading-modal-logo">
        <div class="loading-modal-progress" ng-if="!loadingError">
            Cargando...
        </div>
        <div class="loading-modal-error" ng-if="loadingError">
            {{ loadingError }}
        </div>
        <button ng-if="loadingError" 
                class="loading-modal-retry-btn" 
                ng-click="retryLoad()">
            Reintentar
        </button>
    </div>

    <div class="main-layout" ng-style="{'opacity': showLoadingModal ? 0 : 1, 'pointer-events': showLoadingModal ? 'none' : 'auto', 'transition': 'opacity 0.5s ease'}">
        <!-- Logo en esquina superior izquierda -->
        <div class="logo-top-left">
            <img src="images/logo.png" alt="Poesía y Cumbia Radio">
        </div>

        <!-- Imagen del programa según horario -->
        <div class="program-image-container">
            <img ng-src="{{ currentProgramImage }}" 
                 alt="Programa actual" 
                 class="program-image"
                 
                 onerror="this.src='images/programas/default.png'">
        </div>

        <!-- Now Playing - Centro grande -->
        <div class="now-playing">
            <!-- Si hay datos de la API, mostrar arte y ficha técnica -->
            <div ng-if="nowPlaying && nowPlaying.song" class="now-playing-content">
                <!-- Fila 1: Info (ancho completo) -->
                <div class="now-playing-info">
                    <div class="now-playing-info-item" 
                         ng-class="{'animating-out': animatingNowPlaying && previousNowPlayingId, 'animating-in': animatingNowPlaying && !previousNowPlayingId}"
                         ng-if="nowPlaying.song.title">
                        <svg class="info-icon" viewBox="0 0 24 24" fill="white" width="20" height="20">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <div class="now-playing-info-value title">{{ nowPlaying.song.title }}</div>
                    </div>
                    <div class="now-playing-info-item" 
                         ng-class="{'animating-out': animatingNowPlaying && previousNowPlayingId, 'animating-in': animatingNowPlaying && !previousNowPlayingId}"
                         ng-if="nowPlaying.song.artist">
                        <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                        <div class="now-playing-info-value artist">{{ nowPlaying.song.artist }}</div>
                    </div>
                    <div class="now-playing-info-item" 
                         ng-class="{'animating-out': animatingNowPlaying && previousNowPlayingId, 'animating-in': animatingNowPlaying && !previousNowPlayingId}"
                         ng-if="nowPlaying.song.album">
                        <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 12 14 10 12 3 19"/>
                        </svg>
                        <div class="now-playing-info-value album">{{ nowPlaying.song.album }}</div>
                    </div>
                    <div class="now-playing-info-item" 
                         ng-class="{'animating-out': animatingNowPlaying && previousNowPlayingId, 'animating-in': animatingNowPlaying && !previousNowPlayingId}"
                         ng-if="nowPlaying.song.lyrics">
                        <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="20" height="20">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10 9 9 9 8 9"/>
                        </svg>
                        <div class="now-playing-info-value lyrics">{{ nowPlaying.song.lyrics }}</div>
                    </div>
                    <div class="song-history-divider"></div>
                </div>

                <!-- Fila 2: Art -->
                <div class="now-playing-art-wrapper">
                    <img ng-if="nowPlaying.song.art" 
                         ng-src="{{ nowPlaying.song.art }}" 
                         alt="Now Playing" 
                         class="now-playing-art"
                         ng-class="{'animating-out': animatingNowPlaying && previousNowPlayingId, 'animating-in': animatingNowPlaying && !previousNowPlayingId, 'playing': isPlaying && rotationEnabled}"
                         onerror="this.style.display='none'">
                </div>

                <!-- Playing Next - Fila 2, Col 2 -->
                <div class="playing-next playing-next-inline">
                    <img src="images/siguiente.png" alt="Siguiente canción" class="playing-next-label">
                    <div class="song-history-divider"></div>
                    <img ng-if="playingNext && playingNext.song && playingNext.song.art" 
                         ng-src="{{ playingNext.song.art }}" 
                         alt="Playing Next" 
                         class="playing-next-art"
                         ng-class="{'animating-out': animatingPlayingNext && previousPlayingNextId, 'animating-in': animatingPlayingNext && !previousPlayingNextId}"
                         onerror="this.style.display='none'">
                    <div ng-if="playingNext && playingNext.song && playingNext.song.text" 
                         class="playing-next-text"
                         ng-class="{'animating-out': animatingPlayingNext && previousPlayingNextId, 'animating-in': animatingPlayingNext && !previousPlayingNextId}">
                        {{ playingNext.song.artist }} -  {{ playingNext.song.title }}
                    </div>
                </div>

                <!-- Fila 3: Controls -->
                <div class="now-playing-controls">
                    <button class="btn-play-pause" ng-click="togglePlay()" ng-disabled="isLoading">
                        <svg ng-if="!isPlaying" class="play-icon" viewBox="0 0 24 24" fill="white" width="32" height="32">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg ng-if="isPlaying" class="pause-icon" viewBox="0 0 24 24" fill="white" width="32" height="32">
                            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                        </svg>
                    </button>
                    
                    <button class="btn-rotation" ng-click="toggleRotation()" ng-disabled="!isPlaying" title="{{rotationEnabled ? 'Desactivar rotación' : 'Activar rotación'}}">
                        <svg ng-if="!rotationEnabled" class="rotation-icon-off" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 8v4l3 3" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <svg ng-if="rotationEnabled" class="rotation-icon-on" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 8v4l3 3" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    
                    <!-- Barra de progreso de tiempo -->
                    <div class="progress-container" ng-if="nowPlaying && (nowPlaying.elapsed !== undefined || nowPlaying.duration)">
                        <div class="progress-bar-container">
                            <div class="progress-bar" ng-style="{'width': getProgressPercentage() + '%'}"></div>
                        </div>
                        <div class="progress-time">
                            <span class="progress-time-elapsed">{{ formatTime(nowPlaying.elapsed) }}</span>
                            <span class="progress-time-remaining" ng-if="nowPlaying.remaining">-{{ formatTime(nowPlaying.remaining) }}</span>
                        </div>
                    </div>
                </div>

                <!-- Song History - Fila 3, Col 2 -->
                <div class="song-history">
                    <div class="song-history-header">
                        <div class="song-history-header-left">
                            <img src="images/recien.png" alt="Recién escuchaste..." class="song-history-label">
                            <div class="song-history-divider"></div>
                        </div>
                    </div>
                    <div class="song-history-items" ng-click="closeHistoryModal()">
                        <div ng-repeat="item in songHistory | limitTo:6" 
                             class="history-item"
                             ng-class="{'animating-in': animatingHistoryItem && $index === 0, 'expanded': expandedHistoryIndex === $index}">
                            <div class="history-art-wrapper" ng-click="$event.stopPropagation(); toggleHistoryItem($index)">
                                <img ng-if="item.song && item.song.art" 
                                     ng-src="{{ item.song.art }}" 
                                     alt="{{ item.song.text }}" 
                                     class="history-art"
                                     onerror="this.style.display='none'">
                                <div ng-if="expandedHistoryIndex === $index && item.song && item.song.text" 
                                     class="history-modal"
                                     ng-click="$event.stopPropagation()">
                                    <div class="history-modal-content">
                                        <div class="history-modal-text">
                                            <div class="history-modal-artist" ng-if="item.song.artist">{{ item.song.artist }}</div>
                                            <div class="history-modal-title" ng-if="item.song.title">{{ item.song.title }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Si no hay datos de la API, mostrar logo en el centro -->
            <div ng-if="!nowPlaying || !nowPlaying.song" 
                 style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
                <img src="images/logo.png" alt="Poesía y Cumbia Radio" class="logo-center">
            </div>

            
        </div>


        <div class="loading-notification" ng-if="error" ng-class="{'show': error}">
            Error: {{ error }}
        </div>
    </div>

    <!-- Video player para el stream HLS (oculto, solo audio) -->
    <video id="videoPlayer" autoplay style="display: none;"></video>

    <script>
        var app = angular.module('RadioApp', []);

        app.controller('RadioController', function($scope, $timeout) {
            //var radioUrl = 'https://studio.loovacast.com/hls/poesiaycumbia/live.m3u8';
            var radioUrl = 'https://a11.asurahosting.com/hls/poesia_y_cumbia_radio/live.m3u8';
            var hls = null;

            $scope.isPlaying = false;
            $scope.isLoading = false;
            $scope.rotationEnabled = true;
            $scope.error = null;
            $scope.nowPlaying = null;
            $scope.playingNext = null;
            $scope.songHistory = [];
            $scope.currentProgramImage = 'images/programas/default.png';
            
            // Variables para modal de carga
            $scope.showLoadingModal = true;
            $scope.bufferingProgress = 0;
            $scope.loadingError = null;
            
            // Variables para animaciones
            var previousNowPlayingId = null;
            var previousPlayingNextId = null;
            $scope.animatingNowPlaying = false;
            $scope.animatingPlayingNext = false;
            $scope.animatingHistoryItem = false;
            $scope.animatingProgramImage = false;
            
            // Variable para rastrear qué item del historial está expandido
            $scope.expandedHistoryIndex = null;
            $scope.previousNowPlayingId = null;
            $scope.previousPlayingNextId = null;
            var previousProgramImage = null;
            
            //var apiUrl = 'https://studio.loovacast.com/api/nowplaying/106';
             var apiUrl = 'https://a11.asurahosting.com/api/nowplaying/129';
            var apiUpdateInterval = null;
            var timeUpdateInterval = null;
            var songStartTime = null;
            var initialElapsed = 0;
            var programImageInterval = null;

            // Función para formatear tiempo en formato MM:SS
            $scope.formatTime = function(seconds) {
                if (!seconds && seconds !== 0) {
                    return '0:00';
                }
                var mins = Math.floor(seconds / 60);
                var secs = Math.floor(seconds % 60);
                return mins + ':' + (secs < 10 ? '0' : '') + secs;
            };

            // Función para calcular el porcentaje de progreso
            $scope.getProgressPercentage = function() {
                if (!$scope.nowPlaying || !$scope.nowPlaying.duration || $scope.nowPlaying.duration === 0) {
                    return 0;
                }
                var elapsed = $scope.nowPlaying.elapsed || 0;
                var percentage = (elapsed / $scope.nowPlaying.duration) * 100;
                return Math.min(100, Math.max(0, percentage));
            };

            // Función para iniciar la actualización del tiempo cada segundo
            function startTimeUpdate(nowPlayingData) {
                // Limpiar intervalo anterior si existe
                if (timeUpdateInterval) {
                    clearInterval(timeUpdateInterval);
                    timeUpdateInterval = null;
                }

                // Si no hay datos de tiempo, no iniciar el intervalo
                if (!nowPlayingData || !nowPlayingData.duration) {
                    return;
                }

                // Guardar el tiempo inicial y elapsed inicial
                songStartTime = Date.now();
                initialElapsed = nowPlayingData.elapsed || 0;

                // Iniciar intervalo que actualiza cada segundo
                timeUpdateInterval = setInterval(function() {
                    if (!$scope.nowPlaying || !$scope.nowPlaying.duration) {
                        return;
                    }

                    // Calcular tiempo transcurrido desde que empezó la canción
                    var elapsedSeconds = Math.floor((Date.now() - songStartTime) / 1000) + initialElapsed;
                    
                    // Limitar al tiempo total de la canción
                    if (elapsedSeconds >= $scope.nowPlaying.duration) {
                        elapsedSeconds = $scope.nowPlaying.duration;
                    }

                    // Actualizar elapsed y remaining
                    $scope.$apply(function() {
                        $scope.nowPlaying.elapsed = elapsedSeconds;
                        if ($scope.nowPlaying.duration) {
                            $scope.nowPlaying.remaining = $scope.nowPlaying.duration - elapsedSeconds;
                        }
                    });
                }, 1000);
            }

            // Función para detener la actualización del tiempo
            function stopTimeUpdate() {
                if (timeUpdateInterval) {
                    clearInterval(timeUpdateInterval);
                    timeUpdateInterval = null;
                }
                songStartTime = null;
                initialElapsed = 0;
            }

            // Función para determinar la imagen del programa según hora y día
            function getProgramImage() {
                var now = new Date();
                var day = now.getDay(); // 0 = Domingo, 1 = Lunes, ..., 6 = Sábado
                var hour = now.getHours(); // 0-23

                // Lunes a Domingo de 17 a 21 hrs (prioridad)
                if (hour >= 17 && hour < 21) {
                    return 'images/programas/tu_tarde_bkn.png';
                }
                
                // Domingo a Jueves (0-4) de 21 hrs a 5am
                if ((day >= 0 && day <= 4) && (hour >= 21 || hour < 5)) {
                    return 'images/programas/noche_de_cucharitas.png';
                }
                
                // Viernes y Sábado (5-6) de 21 hrs a 5am
                if ((day === 5 || day === 6) && (hour >= 21 || hour < 5)) {
                    return 'images/programas/dance_y_vacile.png';
                }
                
                // Lunes a Domingo de 05 am a 09 am
                if (hour >= 5 && hour < 9) {
                    return 'images/programas/levantate_papito.png';
                }
                
                // Lunes a Domingo de 09 am a 17 hrs
                if (hour >= 9 && hour < 17) {
                    return 'images/programas/antologia.png';
                }
                
                // Cualquier otro horario
                return 'images/programas/default.png';
            }

            // Función para actualizar la imagen del programa
            function updateProgramImage() {
                var newImage = getProgramImage();
                var imageChanged = previousProgramImage !== null && previousProgramImage !== newImage;
                
                $scope.$apply(function() {
                    // Si la imagen cambió, activar animación
                    if (imageChanged) {
                        $scope.animatingProgramImage = true;
                    }
                    $scope.currentProgramImage = newImage;
                });
                
                // Si la imagen cambió, remover la clase de animación después de completar
                if (imageChanged) {
                    $timeout(function() {
                        $scope.$apply(function() {
                            $scope.animatingProgramImage = false;
                        });
                    }, 1000); // Duración de la animación
                }
                
                previousProgramImage = newImage;
            }

            // Actualizar imagen del programa cada minuto
            programImageInterval = setInterval(function() {
                updateProgramImage();
            }, 60000); // Actualizar cada minuto

            // Función simplificada para cargar el canal HLS
            function loadChannel() {
                var videoPlayer = document.getElementById('videoPlayer');
                if (!videoPlayer) {
                    console.error('Video player no encontrado');
                    return;
                }
                
                // Configurar listeners para el estado del video
                videoPlayer.addEventListener('playing', function() {
                    console.log('Video empezó a reproducir');
                    $scope.$apply(function() {
                        $scope.isPlaying = true;
                        $scope.isLoading = false;
                        $scope.showLoadingModal = false;
                    });
                });
                
                videoPlayer.addEventListener('pause', function() {
                    console.log('Video pausado');
                    $scope.$apply(function() {
                        $scope.isPlaying = false;
                    });
                });
                
                videoPlayer.addEventListener('waiting', function() {
                    console.log('Video esperando datos');
                    $scope.$apply(function() {
                        $scope.isLoading = true;
                    });
                });
                
                if (Hls.isSupported()) {
                    console.log('HLS.js is supported');
                    hls = new Hls();
                    hls.loadSource(radioUrl);
                    hls.attachMedia(videoPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log('HLS manifest parsed');
                        // No reproducir automáticamente - esperar interacción del usuario
                        // El usuario iniciará la reproducción con el botón de reproducir
                        $scope.$apply(function() {
                            $scope.isLoading = false;
                        });
                    });
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS.js error:', data);
                        $scope.$apply(function() {
                            $scope.isLoading = false;
                            $scope.error = 'Error al cargar el stream: ' + (data.details || 'Error desconocido');
                            $scope.loadingError = 'Error al cargar el stream: ' + (data.details || 'Error desconocido');
                            $scope.showLoadingModal = true;
                        });
                    });
                } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    console.log('Native HLS support detected');
                    videoPlayer.src = radioUrl;
                    videoPlayer.addEventListener('loadedmetadata', function() {
                        console.log('Video metadata loaded');
                        // No reproducir automáticamente - esperar interacción del usuario
                        // El usuario iniciará la reproducción con el botón de reproducir
                        $scope.$apply(function() {
                            $scope.isLoading = false;
                        });
                    });
                    videoPlayer.addEventListener('error', function(event) {
                        console.error('Video player error:', event);
                        $scope.$apply(function() {
                            $scope.isLoading = false;
                            $scope.error = 'Error al cargar el stream';
                            $scope.loadingError = 'Error al cargar el stream';
                            $scope.showLoadingModal = true;
                            
                            // Ocultar error después de 2 segundos
                            $timeout(function() {
                                $scope.error = null;
                            }, 2000);
                        });
                    });
                } else {
                    console.error('HLS is not supported in this browser.');
                    $scope.$apply(function() {
                        $scope.error = 'HLS no es compatible con este navegador. Por favor usa un navegador compatible.';
                        $scope.loadingError = 'HLS no es compatible con este navegador. Por favor usa un navegador compatible.';
                        $scope.showLoadingModal = true;
                        
                        // Ocultar error después de 2 segundos
                        $timeout(function() {
                            $scope.error = null;
                        }, 2000);
                    });
                }
            }

            // Función para pre-cargar imágenes
            function preloadImages(imageUrls, callback) {
                var loadedCount = 0;
                var totalImages = imageUrls.length;
                
                if (totalImages === 0) {
                    callback();
                    return;
                }
                
                imageUrls.forEach(function(url) {
                    if (!url) {
                        loadedCount++;
                        if (loadedCount === totalImages) {
                            callback();
                        }
                        return;
                    }
                    
                    var img = new Image();
                    img.onload = function() {
                        loadedCount++;
                        if (loadedCount === totalImages) {
                            callback();
                        }
                    };
                    img.onerror = function() {
                        loadedCount++;
                        if (loadedCount === totalImages) {
                            callback();
                        }
                    };
                    img.src = url;
                });
            }

            // Función para obtener información de la API
            function fetchNowPlaying() {
                try {
                    // Intentar con jQuery primero (ya está incluido)
                    if (typeof $ !== 'undefined' && $.ajax) {
                        $.ajax({
                            url: apiUrl,
                            type: 'GET',
                            dataType: 'json',
                            timeout: 10000,
                            crossDomain: true,
                            xhrFields: {
                                withCredentials: false
                            },
                            success: function(data) {
                                console.log('Datos obtenidos de API:', data);
                                $scope.$apply(function() {
                                    var newNowPlayingId = data.now_playing && data.now_playing.song ? data.now_playing.song.id : null;
                                    var newPlayingNextId = data.playing_next && data.playing_next.song ? data.playing_next.song.id : null;
                                    
                                    // Detectar si es la primera carga o si cambió la canción
                                    var isFirstLoad = !previousNowPlayingId;
                                    var songChanged = previousNowPlayingId && newNowPlayingId && previousNowPlayingId !== newNowPlayingId;
                                    
                                    // Detectar cambios para animaciones
                                    var shouldAnimate = false;
                                    if (songChanged) {
                                        // La canción actual cambió - activar animaciones
                                        shouldAnimate = true;
                                        
                                        // Detener actualización del tiempo de la canción anterior
                                        stopTimeUpdate();
                                        
                                        // Pre-cargar imágenes ANTES de iniciar animaciones
                                        var imagesToPreload = [];
                                        if (data.now_playing && data.now_playing.song && data.now_playing.song.art) {
                                            imagesToPreload.push(data.now_playing.song.art);
                                        }
                                        if (data.playing_next && data.playing_next.song && data.playing_next.song.art) {
                                            imagesToPreload.push(data.playing_next.song.art);
                                        }
                                        
                                        // Pre-cargar imágenes primero
                                        preloadImages(imagesToPreload, function() {
                                            // Una vez que las imágenes están cargadas, iniciar animaciones
                                            
                                            // Activar animación de salida en elementos actuales
                                            $scope.animatingNowPlaying = true;
                                            $scope.animatingPlayingNext = true;
                                            
                                            // Detectar si hay un nuevo item en el historial que coincide con la canción anterior
                                            if (data.song_history && data.song_history.length > 0) {
                                                var firstHistoryId = data.song_history[0].song ? data.song_history[0].song.id : null;
                                                if (firstHistoryId === previousNowPlayingId) {
                                                    $scope.animatingHistoryItem = true;
                                                }
                                            }
                                            
                                            // Esperar a que termine la animación de salida (600ms)
                                            $timeout(function() {
                                                // Limpiar IDs anteriores para activar animación de entrada
                                                $scope.previousNowPlayingId = null;
                                                $scope.previousPlayingNextId = null;
                                                
                                                // Actualizar datos (las imágenes ya están cargadas)
                                                $scope.nowPlaying = data.now_playing || null;
                                                $scope.playingNext = data.playing_next || null;
                                                $scope.songHistory = data.song_history || [];
                                                
                                                // Forzar digest cycle para que Angular renderice los nuevos elementos
                                                $scope.$apply();
                                                
                                                // Pequeño delay para asegurar que el DOM se actualizó
                                                $timeout(function() {
                                                    // Iniciar actualización del tiempo para la nueva canción
                                                    if ($scope.nowPlaying) {
                                                        startTimeUpdate($scope.nowPlaying);
                                                    }
                                                    
                                                    // Si es la primera carga exitosa, ocultar el modal de carga
                                                    if (isFirstLoad) {
                                                        $scope.showLoadingModal = false;
                                                        $scope.loadingError = null;
                                                    }
                                                    
                                                    // Remover clases de animación después de completar entrada (1000ms)
                                                    $timeout(function() {
                                                        $scope.animatingNowPlaying = false;
                                                        $scope.animatingPlayingNext = false;
                                                        $scope.animatingHistoryItem = false;
                                                        $scope.previousNowPlayingId = newNowPlayingId;
                                                        $scope.previousPlayingNextId = newPlayingNextId;
                                                    }, 2000);
                                                }, 50);
                                            }, 2000);
                                        });
                                    } else {
                                        // Sin cambios, actualizar normalmente
                                        $scope.nowPlaying = data.now_playing || null;
                                        $scope.playingNext = data.playing_next || null;
                                        $scope.songHistory = data.song_history || [];
                                        
                                        // Si es la primera carga, iniciar actualización del tiempo
                                        if (isFirstLoad && $scope.nowPlaying) {
                                            startTimeUpdate($scope.nowPlaying);
                                        }
                                    }
                                    
                                    // Si es la primera carga exitosa, ocultar el modal de carga
                                    if (isFirstLoad) {
                                        $scope.showLoadingModal = false;
                                        $scope.loadingError = null;
                                    }
                                    
                                    // Actualizar IDs anteriores
                                    previousNowPlayingId = newNowPlayingId;
                                    previousPlayingNextId = newPlayingNextId;
                                });
                            },
                            error: function(xhr, status, error) {
                                console.log('Error jQuery:', status, error, xhr);
                                // Intentar con XMLHttpRequest como fallback
                                tryXHR();
                            }
                        });
                    } else {
                        // Si jQuery no está disponible, intentar XMLHttpRequest
                        tryXHR();
                    }
                } catch (e) {
                    console.log('Error al hacer petición a API:', e);
                    tryXHR();
                }
            }

            // Función auxiliar para usar XMLHttpRequest
            function tryXHR() {
                try {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', apiUrl, true);
                    xhr.timeout = 10000;
                    xhr.onload = function() {
                        if (xhr.status === 200 || xhr.status === 0) {
                            try {
                                var data = JSON.parse(xhr.responseText);
                                var newNowPlayingId = data.now_playing && data.now_playing.song ? data.now_playing.song.id : null;
                                var newPlayingNextId = data.playing_next && data.playing_next.song ? data.playing_next.song.id : null;
                                var isFirstLoad = !previousNowPlayingId;
                                var songChanged = previousNowPlayingId && newNowPlayingId && previousNowPlayingId !== newNowPlayingId;
                                
                                if (songChanged) {
                                    // Detener actualización del tiempo de la canción anterior
                                    stopTimeUpdate();
                                    
                                    // Pre-cargar imágenes ANTES de iniciar animaciones
                                    var imagesToPreload = [];
                                    if (data.now_playing && data.now_playing.song && data.now_playing.song.art) {
                                        imagesToPreload.push(data.now_playing.song.art);
                                    }
                                    if (data.playing_next && data.playing_next.song && data.playing_next.song.art) {
                                        imagesToPreload.push(data.playing_next.song.art);
                                    }
                                    
                                    // Pre-cargar imágenes primero
                                    preloadImages(imagesToPreload, function() {
                                        $scope.$apply(function() {
                                            // Una vez que las imágenes están cargadas, iniciar animaciones
                                            
                                            // Activar animación de salida en elementos actuales
                                            $scope.animatingNowPlaying = true;
                                            $scope.animatingPlayingNext = true;
                                            
                                            // Detectar si hay un nuevo item en el historial que coincide con la canción anterior
                                            if (data.song_history && data.song_history.length > 0) {
                                                var firstHistoryId = data.song_history[0].song ? data.song_history[0].song.id : null;
                                                if (firstHistoryId === previousNowPlayingId) {
                                                    $scope.animatingHistoryItem = true;
                                                }
                                            }
                                            
                                            // Esperar a que termine la animación de salida (600ms)
                                            $timeout(function() {
                                                // Limpiar IDs anteriores para activar animación de entrada
                                                $scope.previousNowPlayingId = null;
                                                $scope.previousPlayingNextId = null;
                                                
                                                // Actualizar datos (las imágenes ya están cargadas)
                                                $scope.nowPlaying = data.now_playing || null;
                                                $scope.playingNext = data.playing_next || null;
                                                $scope.songHistory = data.song_history || [];
                                                
                                                // Pequeño delay para asegurar que el DOM se actualizó
                                                $timeout(function() {
                                                    // Iniciar actualización del tiempo para la nueva canción
                                                    if ($scope.nowPlaying) {
                                                        startTimeUpdate($scope.nowPlaying);
                                                    }
                                                    
                                                    // Si es la primera carga exitosa, ocultar el modal de carga
                                                    if (isFirstLoad) {
                                                        $scope.showLoadingModal = false;
                                                        $scope.loadingError = null;
                                                    }
                                                    
                                                    // Remover clases de animación después de completar entrada (1000ms)
                                                    $timeout(function() {
                                                        $scope.animatingNowPlaying = false;
                                                        $scope.animatingPlayingNext = false;
                                                        $scope.animatingHistoryItem = false;
                                                        $scope.previousNowPlayingId = newNowPlayingId;
                                                        $scope.previousPlayingNextId = newPlayingNextId;
                                                    }, 20000);
                                                }, 50);
                                            }, 2000);
                                        });
                                    });
                                } else {
                                    $scope.$apply(function() {
                                        $scope.nowPlaying = data.now_playing || null;
                                        $scope.playingNext = data.playing_next || null;
                                        $scope.songHistory = data.song_history || [];
                                        
                                        // Si es la primera carga, iniciar actualización del tiempo
                                        if (isFirstLoad && $scope.nowPlaying) {
                                            startTimeUpdate($scope.nowPlaying);
                                        }
                                        
                                        // Si es la primera carga exitosa, ocultar el modal de carga
                                        if (isFirstLoad) {
                                            $scope.showLoadingModal = false;
                                            $scope.loadingError = null;
                                        }
                                        
                                        previousNowPlayingId = newNowPlayingId;
                                        previousPlayingNextId = newPlayingNextId;
                                    });
                                }
                            } catch (e) {
                                console.log('Error al parsear respuesta:', e);
                            }
                        } else {
                            console.log('Error HTTP:', xhr.status);
                        }
                    };
                    xhr.onerror = function() {
                        console.log('Error de red en XHR');
                    };
                    xhr.ontimeout = function() {
                        console.log('Timeout en petición XHR');
                    };
                    xhr.send();
                } catch (e) {
                    console.log('Error en XHR:', e);
                }
            }

            // Función para reiniciar la carga del stream
            $scope.retryLoad = function() {
                console.log('Reintentando carga del stream...');
                
                // Resetear variables
                $scope.showLoadingModal = true;
                $scope.bufferingProgress = 0;
                $scope.loadingError = null;
                $scope.error = null;
                $scope.isLoading = true;
                $scope.isPlaying = false;
                
                // Detener y destruir HLS si existe
                if (hls) {
                    hls.destroy();
                    hls = null;
                }
                
                // Reiniciar carga
                $timeout(function() {
                    loadChannel();
                }, 100);
            };

            // Función para activar/desactivar la rotación del disco
            $scope.toggleRotation = function() {
                $scope.rotationEnabled = !$scope.rotationEnabled;
            };

            // Función para expandir/colapsar items del historial
            $scope.toggleHistoryItem = function(index) {
                if ($scope.expandedHistoryIndex === index) {
                    $scope.expandedHistoryIndex = null;
                } else {
                    $scope.expandedHistoryIndex = index;
                }
            };

            // Cerrar modal del historial al hacer click fuera
            $scope.closeHistoryModal = function() {
                $scope.expandedHistoryIndex = null;
            };

            // Función para reproducir/pausar
            $scope.togglePlay = function() {
                var videoPlayer = document.getElementById('videoPlayer');
                if (!videoPlayer) {
                    $scope.$apply(function() {
                        $scope.error = 'Reproductor no disponible';
                        
                        // Ocultar error después de 2 segundos
                        $timeout(function() {
                            $scope.error = null;
                        }, 2000);
                    });
                    return;
                }

                try {
                    // El estado se actualizará automáticamente con los event listeners
                    if ($scope.isPlaying) {
                        videoPlayer.pause();
                    } else {
                        $scope.isLoading = true;
                        $scope.error = null;
                        var playPromise = videoPlayer.play();
                        // Manejar errores de la promesa de play()
                        if (playPromise !== undefined) {
                            playPromise.catch(function(error) {
                                console.log('Error al reproducir:', error);
                                $scope.$apply(function() {
                                    $scope.isLoading = false;
                                    $scope.error = 'Error al iniciar la reproducción: ' + (error.message || error.name || 'Error desconocido');
                                    
                                    // Ocultar error después de 2 segundos
                                    $timeout(function() {
                                        $scope.error = null;
                                    }, 2000);
                                });
                            });
                        }
                    }
                } catch (e) {
                    console.log('Error en togglePlay:', e);
                    $scope.$apply(function() {
                        $scope.isLoading = false;
                        $scope.error = 'Error: ' + (e.message || e.name || 'Error desconocido');
                        
                        // Ocultar error después de 2 segundos
                        $timeout(function() {
                            $scope.error = null;
                        }, 2000);
                    });
                }
            };

            // Inicializar cuando el controlador esté listo
            $timeout(function() {
                // Cargar datos de la API inmediatamente
                fetchNowPlaying();
                
                // Actualizar datos de la API cada 20 segundos
                apiUpdateInterval = setInterval(function() {
                    fetchNowPlaying();
                }, 20000);
                
                // Cargar el stream HLS
                loadChannel();
                
                // Inicializar imagen del programa
                // Activar animación en la carga inicial
                $scope.animatingProgramImage = true;
                updateProgramImage();
                $timeout(function() {
                    $scope.$apply(function() {
                        $scope.animatingProgramImage = false;
                    });
                }, 1000);
            }, 500);
            
            // Limpiar intervalos cuando se destruye el scope
            $scope.$on('$destroy', function() {
                if (apiUpdateInterval) {
                    clearInterval(apiUpdateInterval);
                }
                if (programImageInterval) {
                    clearInterval(programImageInterval);
                }
                stopTimeUpdate();
            });
        });
    </script>
</body>
</html>
